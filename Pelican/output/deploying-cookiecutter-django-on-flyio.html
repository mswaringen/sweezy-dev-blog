<!DOCTYPE html>
<html lang="en">
<head>
          <title>sweezy.dev - Deploying Cookiecutter Django on Fly.io</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css" />





</head>

<body>
        <header>
              <hgroup><h1><a href="/">sweezy.dev</a></h1></hgroup>
        <nav><ul>
            <li><a href="/pages/about.html" >about</a></li>
            <li><a href="/category/devops.html"  aria-current="page" >devops</a></li>
        </ul></nav>
        </header>
        <main>
<article>
  <header>
    <h2>
      <a href="/deploying-cookiecutter-django-on-flyio.html" rel="bookmark"
         title="Permalink to Deploying Cookiecutter Django on Fly.io">Deploying Cookiecutter Django on Fly.io</a></h2>
 
  </header>
  <h1>Deploying Cookiecutter Django on Fly.io</h1>
<h3><em>with Celery, Postgres, Redis, and S3 storage with Tigris</em></h3>
<h2>tl;dr</h2>
<p>Cookiecutter Django is awesome but can be difficult to deploy the entire stack apart from the officially supported options. With a few small tweaks we can deploy on Fly.io with everything included (Celery workers, PG, Redis, S3 storage)</p>
<blockquote>
<p>Note: We will be using the celery_django_results package to save job status to Postgres and view results in Django Admin. This is used as a replacement for Flower in production.</p>
</blockquote>
<h2>Steps</h2>
<p>1) Generate project locally for Docker</p>
<p>2) Add new Dockerfile + fly.toml</p>
<p>3) Inject secrets from CLI</p>
<p>4) Fly launch + fly deploy</p>
<p>Now lets dive in...</p>
<h2>1) Generate project locally with Docker</h2>
<p>Prereqs: Docker, Cookiecutter</p>
<p>Follow the <a href="https://cookiecutter-django.readthedocs.io/en/latest/developing-locally-docker.html">instructions</a> to setup a local project with Docker. </p>
<h3><em>Optional</em></h3>
<h4><em>A) Create test-task view</em></h4>
<p>This view will trigger a worker action upon GET request, letting us easily observe the entire system in action.</p>
<p>1) Add the following function to <code>config/celery_app.py</code> </p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="nv">@app</span><span class="p">.</span><span class="n">task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">ignore_result</span><span class="o">=</span><span class="k">False</span><span class="p">)</span>
<span class="w">   </span><span class="n">def</span><span class="w"> </span><span class="n">example_task</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="err">:</span>
<span class="w">      </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;You&#39;ve triggered the example task!&quot;</span><span class="p">)</span>
</code></pre></div>

<p>2) Create <code>test_views.py</code> in the <code>config</code> directory and add the following code</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">HttpResponse</span>
<span class="w">   </span><span class="kn">from</span><span class="w"> </span><span class="nn">.celery_app</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">example_task</span>

<span class="w">   </span><span class="k">def</span><span class="w"> </span><span class="nf">test_task</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">      </span><span class="n">example_task</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Task triggered, see Celery logs&quot;</span><span class="p">)</span>
</code></pre></div>

<p>3) Now modify <code>url_patterns</code> in <code>config/urls.py</code> with the line</p>
<div class="highlight"><pre><span></span><code>   path(&quot;test-task/&quot;, test_views.test_task, name=&quot;test_task&quot;),
</code></pre></div>

<p>After importing the view with</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">test_views</span>
</code></pre></div>

<h4><em>B) Install <a href="https://github.com/celery/django-celery-results">celery-django-results</a></em></h4>
<p>This allows us to view the results of Celery worker tasks in the database with Django Admin</p>
<p>1) Add <code>django-celery-results==2.5.1</code> to <code>requirements/base.txt</code></p>
<p>2) Add <code>"django_celery_results",</code> to <code>INSTALLED_APPS</code> in <code>config/settings/base.py</code></p>
<p>3) Further modify <code>base.py</code> with the following additions</p>
<div class="highlight"><pre><span></span><code>   <span class="n">CELERY_RESULT_BACKEND</span> <span class="o">=</span> <span class="n">env</span><span class="p">.</span><span class="n">str</span><span class="p">(</span><span class="s">&quot;CELERY_RESULT_BACKEND&quot;</span><span class="p">,</span> <span class="err">&quot;</span><span class="n">django</span><span class="o">-</span><span class="n">db</span><span class="err">‚Äù</span><span class="p">),</span> 
   <span class="n">CELERY_TASK_TRACK_STARTED</span> <span class="o">=</span> <span class="n">True</span>
</code></pre></div>

<p>Modify the following line to allow CELERY_BROKER_URL to access REDIS_URL directly (this will be set by Fly automatically)</p>
<div class="highlight"><pre><span></span><code>   CELERY_BROKER_URL = env(&#39;CELERY_BROKER_URL&#39;, default=env(&#39;REDIS_URL&#39;))
</code></pre></div>

<p>4) Build and migrate</p>
<div class="highlight"><pre><span></span><code>   docker compose -f local.yml build
   docker compose -f local.yml build
   docker compose -f local.yml run --rm django python manage.py migrate
</code></pre></div>

<h4><em>C) Test locally with Flower and Django Admin</em></h4>
<p>Run the stack and create superuser</p>
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="k">export</span><span class="w"> </span><span class="n">COMPOSE_FILE</span><span class="o">=</span><span class="n">local</span><span class="o">.</span><span class="n">yml</span>
<span class="w">   </span><span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="n">up</span>
<span class="w">   </span><span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">rm</span><span class="w"> </span><span class="n">django</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">manage</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">createsuperuser</span>
</code></pre></div>

<p>In a browser open up three tabs:</p>
<p>1) Flower (Celery worker monitor): <a href="http://localhost:5555/">http://localhost:5555/</a></p>
<blockquote>
<p><em>Note: the login credentials are set in .envs/.local/.django</em></p>
</blockquote>
<p>2) Django Admin: <a href="http://localhost:8000/admin">http://localhost:8000/admin</a></p>
<p>3) Web test-task: <a href="http://localhost:8000/test-task">http://localhost:8000/test-task</a></p>
<blockquote>
<p>The test-task GET request kicks off a worker task. Check the activity in the Flower tab, and then check again in Django Admin under <code>Celery Results / Task Results</code></p>
<blockquote>
<p><em>If you see Task State: SUCCESS you are ready to move to deployment!</em> </p>
</blockquote>
</blockquote>
<h2>2) Create fly.toml and custom Dockerfile</h2>
<p><em><a href="https://fly.io/docs/apps/launch/">Full description</a> of the Fly launch and deploy process</em></p>
<p>Prereqs: flytmcl</p>
<p>Running <code>fly launch</code> will create generic fly.toml and Dockerfile required for deployment, however we need custom files for Cookiecutter Django</p>
<h3>Custom Dockerfile</h3>
<p>This is a version of the Dockerfile found in <code>compose/production/django/Dockerfile</code> modified to fit Fly's build process.</p>
<blockquote>
<p>add notes about injecting dummy vars to run collect</p>
</blockquote>
<p><em>Dockerfile</em></p>
<div class="highlight"><pre><span></span><code><span class="c1"># define an alias for the specific python version used in this file.</span>
<span class="n">FROM</span><span class="w"> </span><span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">python</span><span class="p">:</span><span class="mf">3.12</span><span class="o">.</span><span class="mi">3</span><span class="o">-</span><span class="n">slim</span><span class="o">-</span><span class="n">bookworm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">python</span>

<span class="c1"># Python build stage</span>
<span class="n">FROM</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">stage</span>

<span class="n">ARG</span><span class="w"> </span><span class="n">BUILD_ENVIRONMENT</span><span class="o">=</span><span class="n">production</span>

<span class="c1"># Install apt packages</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span>\
<span class="w">  </span><span class="c1"># dependencies for building Python packages</span>
<span class="w">  </span><span class="n">build</span><span class="o">-</span><span class="n">essential</span><span class="w"> </span>\
<span class="w">  </span><span class="c1"># psycopg dependencies</span>
<span class="w">  </span><span class="n">libpq</span><span class="o">-</span><span class="n">dev</span>

<span class="c1"># Requirements are installed here to ensure they will be cached.</span>
<span class="n">COPY</span><span class="w"> </span><span class="o">./</span><span class="n">requirements</span><span class="w"> </span><span class="o">.</span>

<span class="c1"># Create Python Dependency and Sub-Dependency Wheels.</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">wheel</span><span class="w"> </span><span class="o">--</span><span class="n">wheel</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">wheels</span><span class="w">  </span>\
<span class="w">  </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">BUILD_ENVIRONMENT</span><span class="p">}</span><span class="o">.</span><span class="n">txt</span>


<span class="c1"># Python &#39;run&#39; stage</span>
<span class="n">FROM</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">run</span><span class="o">-</span><span class="n">stage</span>

<span class="n">ARG</span><span class="w"> </span><span class="n">BUILD_ENVIRONMENT</span><span class="o">=</span><span class="n">production</span>
<span class="n">ARG</span><span class="w"> </span><span class="n">APP_HOME</span><span class="o">=/</span><span class="n">code</span>

<span class="n">ENV</span><span class="w"> </span><span class="n">PYTHONUNBUFFERED</span><span class="w"> </span><span class="mi">1</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">PYTHONDONTWRITEBYTECODE</span><span class="w"> </span><span class="mi">1</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">BUILD_ENV</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">BUILD_ENVIRONMENT</span><span class="p">}</span>

<span class="n">WORKDIR</span><span class="w"> </span><span class="o">$</span><span class="p">{</span><span class="n">APP_HOME</span><span class="p">}</span>

<span class="n">RUN</span><span class="w"> </span><span class="n">addgroup</span><span class="w"> </span><span class="o">--</span><span class="n">system</span><span class="w"> </span><span class="n">django</span><span class="w"> </span>\
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">adduser</span><span class="w"> </span><span class="o">--</span><span class="n">system</span><span class="w"> </span><span class="o">--</span><span class="n">ingroup</span><span class="w"> </span><span class="n">django</span><span class="w"> </span><span class="n">django</span>


<span class="c1"># Install required system dependencies</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">install</span><span class="o">-</span><span class="n">recommends</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span>\
<span class="w">  </span><span class="c1"># psycopg dependencies</span>
<span class="w">  </span><span class="n">libpq</span><span class="o">-</span><span class="n">dev</span><span class="w"> </span>\
<span class="w">  </span><span class="c1"># Translations dependencies</span>
<span class="w">  </span><span class="n">gettext</span><span class="w"> </span>\
<span class="w">  </span><span class="c1"># cleaning up unused files</span>
<span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">apt</span><span class="o">-</span><span class="n">get</span><span class="w"> </span><span class="n">purge</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">remove</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">APT</span><span class="p">::</span><span class="n">AutoRemove</span><span class="p">::</span><span class="n">RecommendsImportant</span><span class="o">=</span><span class="bp">false</span><span class="w"> </span>\
<span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>

<span class="c1"># All absolute dir copies ignore workdir instruction. All relative dir copies are wrt to the workdir instruction</span>
<span class="c1"># copy python dependency wheels from python-build-stage</span>
<span class="n">COPY</span><span class="w"> </span><span class="o">--</span><span class="n">from</span><span class="o">=</span><span class="n">python</span><span class="o">-</span><span class="n">build</span><span class="o">-</span><span class="n">stage</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">wheels</span><span class="w">  </span><span class="o">/</span><span class="n">wheels</span><span class="o">/</span>

<span class="c1"># use wheels to install python dependencies</span>
<span class="n">RUN</span><span class="w"> </span><span class="n">pip</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">index</span><span class="w"> </span><span class="o">--</span><span class="n">find</span><span class="o">-</span><span class="n">links</span><span class="o">=/</span><span class="n">wheels</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">wheels</span><span class="o">/*</span><span class="w"> </span>\
<span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="o">/</span><span class="n">wheels</span><span class="o">/</span>

<span class="n">COPY</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="o">/</span><span class="n">code</span>

<span class="c1"># Set dummy vars for building purposes</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_SETTINGS_MODULE</span><span class="w"> </span><span class="s2">&quot;config.settings.production&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DATABASE_URL</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_SECRET_KEY</span><span class="w"> </span><span class="s2">&quot;non-secret-key-for-building-purposes&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">REDIS_URL</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_ADMIN_URL</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_ALLOWED_HOSTS</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">MAILJET_API_KEY</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">MAILJET_SECRET_KEY</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">SENTRY_DSN</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_AWS_ACCESS_KEY_ID</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_AWS_SECRET_ACCESS_KEY</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">DJANGO_AWS_STORAGE_BUCKET_NAME</span><span class="w"> </span><span class="s2">&quot;temp&quot;</span>

<span class="n">RUN</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">manage</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">collectstatic</span><span class="w"> </span><span class="o">--</span><span class="n">noinput</span>

<span class="n">EXPOSE</span><span class="w"> </span><span class="mi">8000</span>

<span class="n">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;gunicorn&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--bind&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;:8000&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--workers&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config.wsgi&quot;</span><span class="p">]</span>
</code></pre></div>

<h3>Custom fly.toml</h3>
<p>As the primary config file, fly.toml here is modifed here to match varible names in the Dockerfile, add a Celery worker process, and run migrate on deploy.</p>
<p>The following variables require user input: <code>app, primary_region</code></p>
<blockquote>
<p>Note the number of workers can be set under <code>processes/app</code> (default is 1)</p>
</blockquote>
<p><em>fly.toml</em></p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">fly</span><span class="p">.</span><span class="n">toml</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="n">generated</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">fly</span><span class="o">-</span><span class="n">cookiecutter</span><span class="o">-</span><span class="n">django</span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="mi">2024</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">01</span><span class="nl">T15</span><span class="p">:</span><span class="mi">44</span><span class="err">:</span><span class="mi">30</span><span class="o">+</span><span class="mi">01</span><span class="err">:</span><span class="mi">00</span>
<span class="err">#</span>
<span class="err">#</span><span class="w"> </span><span class="n">See</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">fly</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">reference</span><span class="o">/</span><span class="n">configuration</span><span class="o">/</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">information</span><span class="w"> </span><span class="n">about</span><span class="w"> </span><span class="n">how</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">use</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">file</span><span class="p">.</span>
<span class="err">#</span>

<span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;fly-cookiecutter-django-1&#39;</span>
<span class="n">primary_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;mad&#39;</span>
<span class="n">console_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/code/manage.py shell&#39;</span>

<span class="o">[</span><span class="n">build</span><span class="o">]</span>

<span class="o">[</span><span class="n">deploy</span><span class="o">]</span>
<span class="w">  </span><span class="n">release_command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;python manage.py migrate&#39;</span>

<span class="o">[</span><span class="n">env</span><span class="o">]</span>
<span class="w">  </span><span class="n">PORT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;8000&#39;</span>

<span class="o">[</span><span class="n">processes</span><span class="o">]</span>
<span class="w">  </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;python -m gunicorn --bind :8000 --workers 1 config.wsgi&#39;</span>
<span class="w">  </span><span class="n">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;python -m celery -A config.celery_app:app worker -l DEBUG&#39;</span>

<span class="o">[</span><span class="n">http_service</span><span class="o">]</span>
<span class="w">  </span><span class="n">internal_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8000</span>
<span class="w">  </span><span class="n">force_https</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">  </span><span class="n">auto_stop_machines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">  </span><span class="n">auto_start_machines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">true</span>
<span class="w">  </span><span class="n">min_machines_running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">  </span><span class="n">processes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">&#39;app&#39;</span><span class="o">]</span>

<span class="o">[</span><span class="n">[vm</span><span class="o">]</span><span class="err">]</span>
<span class="w">  </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1gb&#39;</span>
<span class="w">  </span><span class="n">cpu_kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;shared&#39;</span>
<span class="w">  </span><span class="n">cpus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="o">[</span><span class="n">[statics</span><span class="o">]</span><span class="err">]</span>
<span class="w">  </span><span class="n">guest_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/code/static&#39;</span>
<span class="w">  </span><span class="n">url_prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/static/&#39;</span>
</code></pre></div>

<h2>3) Launch and Deploy</h2>
<h3>Launch</h3>
<p>Run <code>fly launch</code> from the root directory</p>
<p><em>Launch wizard</em></p>
<div class="highlight"><pre><span></span><code>- YES to copy config to new app
- NO to overwriting Dockerfile
- YES to modifying configuration, click to open setting page, select Postgres and Redis instances
</code></pre></div>

<h3>Import secrets</h3>
<ul>
<li>DATABASE_URL and REDIS_URL are set by <code>fly launch</code>, all others need to be imported</li>
<li>Modify <code>.envs/.production/.django</code> as needed, if a service isnt ready just leave a temp value</li>
<li>You must comment out <code>REDIS_URL</code></li>
</ul>
<p>Run the following command to import the secrets to Fly:</p>
<p><code>cat .envs/.production/.django | fly secrets import</code></p>
<h3>Deploy</h3>
<p>Run <code>fly deploy</code></p>
<p>If deployment was successful, create a superuser via ssh console</p>
<div class="highlight"><pre><span></span><code>fly ssh console
python manage.py createsuperuser
</code></pre></div>

<p>Now open tabs for Django Admin and test-task to verify the system is working.</p>
<hr>
<h4>If you've gotten this far congratulations you are now live on Fly.io!</h4>
<h3>Resources</h3>
<ul>
<li><a href="https://github.com/mswaringen/fly-cookiecutter-django">Example code on Github</a></li>
<li><a href="https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/">Deploy with Github Actions</a>  </li>
</ul>
  <footer>
    <p>Published: <time datetime="2024-05-21T16:00:00+01:00">
      Tue 21 May 2024
    </time></p>
    <address>
      By           <a href="/author/mark-swaringen.html">Mark Swaringen</a>
    </address>
    <p>
        Category: <a href="/category/devops.html">devops</a>
    </p>
  </footer>
  </article>
        </main>
        <footer>
                <address>
                Proudly powered by <a rel="nofollow" href="https://getpelican.com/">Pelican</a>,
                which takes great advantage of <a rel="nofollow" href="https://www.python.org/">Python</a>.
                </address>
        </footer>
</body>
</html>